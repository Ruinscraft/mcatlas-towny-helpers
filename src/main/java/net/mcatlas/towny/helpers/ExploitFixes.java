package net.mcatlas.towny.helpers;

import com.palmergames.bukkit.towny.TownyAPI;
import com.palmergames.bukkit.towny.event.NationAddTownEvent;
import com.palmergames.bukkit.towny.event.TownAddResidentEvent;
import com.palmergames.bukkit.towny.exceptions.NotRegisteredException;
import com.palmergames.bukkit.towny.object.Resident;
import com.palmergames.bukkit.towny.object.Town;
import org.bukkit.ChatColor;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerTeleportEvent;

import java.util.ArrayList;
import java.util.List;

public class ExploitFixes implements Listener {

    @EventHandler
    public void doNotTeleportUsersIntoTownClaimsWithChorusFruit(PlayerTeleportEvent event) {
        if (event.getCause() != PlayerTeleportEvent.TeleportCause.CHORUS_FRUIT) {
            return;
        }

        String townName = TownyAPI.getInstance().getTownName(event.getTo());

        // there was a town claim at the randomly chosen location
        if (townName != null) {
            event.getPlayer().sendMessage(ChatColor.RED + "Your teleport was canceled because of a town claim.");
            event.setCancelled(true);
        }
    }

    @EventHandler
    public void onTownAddResident(TownAddResidentEvent event) {
        Resident resident = event.getResident();
        List<String> ranks = new ArrayList<>(resident.getNationRanks());
        for (String rank : resident.getTownRanks()) {
            ranks.add(rank);
        }
        for (String rank : ranks) {
            TownyHelpersPlugin.get().getLogger().info("Removing rank " + rank + " from " + resident.getName());
            try {
                resident.removeNationRank(rank);
                resident.removeTownRank(rank);
            } catch (NotRegisteredException e) { }
        }
    }

    @EventHandler
    public void onNationAddTown(NationAddTownEvent event) {
        Town town = event.getTown();
        for (Resident resident : town.getResidents()) {
            List<String> ranks = new ArrayList<>(resident.getNationRanks());
            for (String rank : ranks) {
                TownyHelpersPlugin.get().getLogger().info("Removing rank " + rank + " from " + resident.getName());
                try {
                    resident.removeNationRank(rank);
                } catch (NotRegisteredException e) { }
            }
        }
    }

}
